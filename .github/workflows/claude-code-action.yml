# Claude Code GitHub Actions Integration
# ìµœì í™”ëœ Claude Code + MCP ì„œë²„ ìžë™í™” ì›Œí¬í”Œë¡œìš°
name: Claude Code Integration

on:
  workflow_dispatch:
    inputs:
      action_type:
        description: 'ì‹¤í–‰í•  ì•¡ì…˜ íƒ€ìž…'
        required: true
        default: 'full'
        type: choice
        options:
          - 'full'
          - 'test'
          - 'deploy'
          - 'analyze'
  push:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches:
      - main
      - develop

env:
  REGISTRY_URL: registry.jclee.me
  CLAUDE_CODE_VERSION: latest
  MCP_SERVERS_CONFIG: .claude/mcp-servers.json

jobs:
  # MCP ì„œë²„ ìƒíƒœ í™•ì¸ ë° ì´ˆê¸°í™”
  mcp-initialization:
    runs-on: ubuntu-latest
    outputs:
      mcp-status: ${{ steps.mcp-check.outputs.status }}
      available-servers: ${{ steps.mcp-check.outputs.servers }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check MCP Servers Configuration
        id: mcp-check
        run: |
          echo "ðŸ” MCP ì„œë²„ ì„¤ì • í™•ì¸ ì¤‘..."
          
          # MCP ì„œë²„ ëª©ë¡ í™•ì¸
          if [ -f ".claude/mcp-servers.json" ]; then
            echo "âœ… MCP ì„œë²„ ì„¤ì • íŒŒì¼ ë°œê²¬"
            SERVERS=$(cat .claude/mcp-servers.json | jq -r '.servers | keys[]' | tr '\n' ',')
            echo "servers=${SERVERS%,}" >> $GITHUB_OUTPUT
            echo "status=configured" >> $GITHUB_OUTPUT
            
            # ì„œë²„ë³„ ìƒíƒœ ì¶œë ¥
            echo "ðŸ“‹ ë“±ë¡ëœ MCP ì„œë²„ë“¤:"
            cat .claude/mcp-servers.json | jq -r '.servers | to_entries[] | "  â€¢ \(.key): \(.value.command[0])"'
          else
            echo "âš ï¸ MCP ì„œë²„ ì„¤ì • íŒŒì¼ ì—†ìŒ - ê¸°ë³¸ ì„¤ì • ìƒì„±"
            mkdir -p .claude
            cat > .claude/mcp-servers.json << 'EOF'
          {
            "servers": {
              "filesystem": {
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-filesystem", "${{ github.workspace }}"]
              },
              "github": {
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-github"],
                "env": {
                  "GITHUB_PERSONAL_ACCESS_TOKEN": "${{ secrets.GITHUB_TOKEN }}"
                }
              },
              "serena": {
                "command": "python3",
                "args": ["-m", "mcp_serena", "--project-path", "${{ github.workspace }}"]
              },
              "brave-search": {
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-brave-search"],
                "env": {
                  "BRAVE_API_KEY": "${{ secrets.BRAVE_API_KEY }}"
                }
              }
            }
          }
          EOF
            echo "status=created" >> $GITHUB_OUTPUT
            echo "servers=filesystem,github,serena,brave-search" >> $GITHUB_OUTPUT
          fi

      - name: Upload MCP Configuration
        uses: actions/upload-artifact@v4
        with:
          name: mcp-config
          path: .claude/mcp-servers.json

  # Claude Code ìŠ¬ëž˜ì‹œ ì»¤ë§¨ë“œ ì„¤ì •
  claude-commands-setup:
    runs-on: ubuntu-latest
    needs: mcp-initialization
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Claude Commands Directory
        run: |
          echo "ðŸš€ Claude Code ì»¤ë§¨ë“œ ë””ë ‰í† ë¦¬ ì„¤ì • ì¤‘..."
          mkdir -p .claude/commands
          
          # Main ìžë™í™” ì»¤ë§¨ë“œ
          cat > .claude/commands/main.sh << 'EOF'
          #!/bin/bash
          # Claude Code /main ì»¤ë§¨ë“œ - ì™„ì „ ìžë™í™” íŒŒì´í”„ë¼ì¸
          set -e
          
          echo "ðŸŽ¯ FortiGate Nextrade ìžë™í™” íŒŒì´í”„ë¼ì¸ ì‹œìž‘..."
          
          # 1. ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
          echo "ðŸ“‹ 1/5 - ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬..."
          black src/ --check
          isort src/ --check-only
          flake8 src/ --max-line-length=120
          
          # 2. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          echo "ðŸ§ª 2/5 - í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
          pytest tests/ -v --cov=src --cov-report=term-missing
          
          # 3. ë³´ì•ˆ ìŠ¤ìº”
          echo "ðŸ”’ 3/5 - ë³´ì•ˆ ìŠ¤ìº”..."
          bandit -r src/ -f json -o security-report.json || true
          safety check --json --output safety-report.json || true
          
          # 4. Docker ì´ë¯¸ì§€ ë¹Œë“œ
          echo "ðŸ³ 4/5 - Docker ì´ë¯¸ì§€ ë¹Œë“œ..."
          docker build -f Dockerfile.production -t fortinet:latest .
          
          # 5. í—¬ìŠ¤ ì²´í¬
          echo "ðŸ¥ 5/5 - ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ ì²´í¬..."
          timeout 30 bash -c 'until curl -f http://localhost:7777/api/health; do sleep 2; done' || true
          
          echo "âœ… ìžë™í™” íŒŒì´í”„ë¼ì¸ ì™„ë£Œ!"
          EOF
          
          # Test ì»¤ë§¨ë“œ
          cat > .claude/commands/test.sh << 'EOF'
          #!/bin/bash
          # Claude Code /test ì»¤ë§¨ë“œ - í†µí•© í…ŒìŠ¤íŠ¸
          set -e
          
          echo "ðŸ§ª FortiGate Nextrade í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸ ì‹¤í–‰..."
          
          # ë³‘ë ¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          pytest tests/unit/ -v -n auto &
          pytest tests/integration/ -v --timeout=30 &
          pytest tests/functional/ -v &
          
          wait
          echo "âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"
          EOF
          
          # Deploy ì»¤ë§¨ë“œ
          cat > .claude/commands/deploy.sh << 'EOF'
          #!/bin/bash
          # Claude Code /deploy ì»¤ë§¨ë“œ - GitOps ë°°í¬
          set -e
          
          echo "ðŸš€ FortiGate Nextrade ë°°í¬ ì‹œìž‘..."
          
          # Git ìƒíƒœ í™•ì¸
          if [ -n "$(git status --porcelain)" ]; then
            echo "ðŸ“ ë³€ê²½ì‚¬í•­ ìžë™ ì»¤ë°‹..."
            git add .
            git commit -m "chore: automated deployment preparation $(date '+%Y-%m-%d %H:%M:%S')"
          fi
          
          # ë©”ì¸ ë¸Œëžœì¹˜ë¡œ í‘¸ì‹œ
          git push origin main
          
          echo "âœ… GitHub Actions íŒŒì´í”„ë¼ì¸ íŠ¸ë¦¬ê±°ë¨!"
          echo "ðŸ“Š íŒŒì´í”„ë¼ì¸ ìƒíƒœ: https://github.com/qws941/fortinet/actions"
          EOF
          
          # Clean ì»¤ë§¨ë“œ
          cat > .claude/commands/clean.sh << 'EOF'
          #!/bin/bash
          # Claude Code /clean ì»¤ë§¨ë“œ - ì½”ë“œ ì •ë¦¬
          set -e
          
          echo "ðŸ§¹ FortiGate Nextrade ì½”ë“œ ì •ë¦¬..."
          
          # ì½”ë“œ í¬ë§·íŒ…
          black src/
          isort src/
          
          # ë¶ˆí•„ìš”í•œ íŒŒì¼ ì œê±°
          find . -name "*.pyc" -delete
          find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
          find . -name ".pytest_cache" -type d -exec rm -rf {} + 2>/dev/null || true
          
          echo "âœ… ì½”ë“œ ì •ë¦¬ ì™„ë£Œ!"
          EOF
          
          chmod +x .claude/commands/*.sh

      - name: Create MCP Integration Commands
        run: |
          echo "ðŸ”Œ MCP í†µí•© ì»¤ë§¨ë“œ ìƒì„± ì¤‘..."
          
          cat > .claude/commands/mcp-status.sh << 'EOF'
          #!/bin/bash
          # MCP ì„œë²„ ìƒíƒœ í™•ì¸
          echo "ðŸ” MCP ì„œë²„ ìƒíƒœ í™•ì¸..."
          
          if [ -f ".claude/mcp-servers.json" ]; then
            echo "ðŸ“‹ ë“±ë¡ëœ MCP ì„œë²„ë“¤:"
            cat .claude/mcp-servers.json | jq -r '.servers | to_entries[] | "  âœ“ \(.key): \(.value.command[0]) \(.value.args[0] // "")"'
          else
            echo "âŒ MCP ì„œë²„ ì„¤ì • íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
          EOF
          
          cat > .claude/commands/auto-workflow.sh << 'EOF'
          #!/bin/bash
          # ìžë™ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
          set -e
          
          echo "ðŸ¤– ìžë™ ì›Œí¬í”Œë¡œìš° ì‹œìž‘..."
          
          # 1. Git ìƒíƒœ ë¶„ì„
          if [ -n "$(git status --porcelain)" ]; then
            echo "ðŸ“ ë³€ê²½ì‚¬í•­ ê°ì§€ - ìžë™ ì²˜ë¦¬ ì‹œìž‘..."
            
            # 2. ì½”ë“œ í’ˆì§ˆ ìžë™ ìˆ˜ì •
            ./claude/commands/clean.sh
            
            # 3. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
            ./claude/commands/test.sh
            
            # 4. ìžë™ ì»¤ë°‹ ë° ë°°í¬
            git add .
            git commit -m "feat: automated workflow improvements $(date '+%Y-%m-%d %H:%M:%S')"
            git push origin main
            
            echo "âœ… ìžë™ ì›Œí¬í”Œë¡œìš° ì™„ë£Œ!"
          else
            echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ - í˜„ìž¬ ìƒíƒœ ì–‘í˜¸"
          fi
          EOF
          
          chmod +x .claude/commands/*.sh

      - name: Upload Claude Commands
        uses: actions/upload-artifact@v4
        with:
          name: claude-commands
          path: .claude/commands/

  # ìžë™í™”ëœ ì½”ë“œ í’ˆì§ˆ ë° í…ŒìŠ¤íŠ¸
  automated-quality-check:
    runs-on: ubuntu-latest
    needs: [mcp-initialization, claude-commands-setup]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: claude-commands
          path: .claude/commands/

      - name: Setup Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest-xdist pytest-cov black isort flake8 bandit safety

      - name: Automated Quality Check
        run: |
          echo "ðŸ” ìžë™í™”ëœ í’ˆì§ˆ ê²€ì‚¬ ì‹¤í–‰..."
          chmod +x .claude/commands/main.sh
          ./.claude/commands/main.sh || true

      - name: Generate Quality Report
        run: |
          echo "ðŸ“Š í’ˆì§ˆ ë¦¬í¬íŠ¸ ìƒì„±..."
          
          cat > quality-report.md << EOF
          # FortiGate Nextrade í’ˆì§ˆ ë¦¬í¬íŠ¸
          
          ## ìƒì„± ì‹œê°„: $(date)
          
          ## ì½”ë“œ í’ˆì§ˆ
          - Black í¬ë§·íŒ…: $(black src/ --check && echo "âœ… í†µê³¼" || echo "âŒ ì‹¤íŒ¨")
          - Import ì •ë ¬: $(isort src/ --check-only && echo "âœ… í†µê³¼" || echo "âŒ ì‹¤íŒ¨")
          - Flake8 ë¦°íŒ…: $(flake8 src/ --max-line-length=120 && echo "âœ… í†µê³¼" || echo "âŒ ì‹¤íŒ¨")
          
          ## í…ŒìŠ¤íŠ¸ ê²°ê³¼
          $(pytest tests/ --tb=short -q || echo "ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨")
          
          ## ë³´ì•ˆ ìŠ¤ìº”
          - Bandit: $([ -f security-report.json ] && echo "âœ… ì™„ë£Œ" || echo "âŒ ë¯¸ì‹¤í–‰")
          - Safety: $([ -f safety-report.json ] && echo "âœ… ì™„ë£Œ" || echo "âŒ ë¯¸ì‹¤í–‰")
          
          ## MCP ì„œë²„ ìƒíƒœ
          $(cat .claude/mcp-servers.json | jq -r '.servers | keys | length')ê°œ ì„œë²„ ë“±ë¡ë¨
          EOF

      - name: Upload Quality Report
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: quality-report.md

  # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ë°°í¬
  automated-deployment:
    runs-on: ubuntu-latest
    needs: automated-quality-check
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_URL }}
          username: admin
          password: bingogo1

      - name: Build and Push Images
        run: |
          echo "ðŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ..."
          
          # ë²„ì „ íƒœê·¸ ìƒì„±
          VERSION=$(date +%Y%m%d-%H%M%S)
          
          # ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ë¯¸ì§€
          docker build -f Dockerfile.production -t $REGISTRY_URL/fortinet:$VERSION -t $REGISTRY_URL/fortinet:latest .
          docker push $REGISTRY_URL/fortinet:$VERSION
          docker push $REGISTRY_URL/fortinet:latest
          
          # Redis ì´ë¯¸ì§€
          docker build -f docker/Dockerfile.redis -t $REGISTRY_URL/fortinet-redis:$VERSION -t $REGISTRY_URL/fortinet-redis:latest .
          docker push $REGISTRY_URL/fortinet-redis:$VERSION
          docker push $REGISTRY_URL/fortinet-redis:latest
          
          # PostgreSQL ì´ë¯¸ì§€
          docker build -f docker/Dockerfile.postgresql -t $REGISTRY_URL/fortinet-postgresql:$VERSION -t $REGISTRY_URL/fortinet-postgresql:latest .
          docker push $REGISTRY_URL/fortinet-postgresql:$VERSION
          docker push $REGISTRY_URL/fortinet-postgresql:latest
          
          echo "âœ… ëª¨ë“  ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ ì™„ë£Œ!"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Deploy to Kubernetes
        run: |
          echo "â˜¸ï¸ Kubernetes ë°°í¬ ì‹œìž‘..."
          
          # Helm ì°¨íŠ¸ íŒ¨í‚¤ì§•
          helm package charts/fortinet/ --version $VERSION --app-version $VERSION
          
          # ArgoCD ë™ê¸°í™” (ê¸°ì¡´ ì„¤ì • ìœ ì§€)
          SYNC_PAYLOAD='{"prune":true,"dryRun":false,"strategy":{"hook":{"force":true},"apply":{"force":true}}}'
          
          echo "ðŸ“¦ ArgoCD ë™ê¸°í™” ì‹¤í–‰..."
          curl -X POST "https://argo.jclee.me/api/v1/applications/fortinet/sync" \
            -H "Authorization: Bearer $ARGOCD_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$SYNC_PAYLOAD" || echo "ArgoCD ë™ê¸°í™” ì‹¤íŒ¨ - ìˆ˜ë™ í™•ì¸ í•„ìš”"

  # ë°°í¬ í›„ ê²€ì¦ ë° ëª¨ë‹ˆí„°ë§
  post-deployment-verification:
    runs-on: ubuntu-latest
    needs: automated-deployment
    if: always() && (needs.automated-deployment.result == 'success' || needs.automated-deployment.result == 'skipped')
    steps:
      - name: Health Check
        run: |
          echo "ðŸ¥ ë°°í¬ í›„ í—¬ìŠ¤ ì²´í¬..."
          
          # 30ì´ˆ ëŒ€ê¸° í›„ í—¬ìŠ¤ ì²´í¬
          sleep 30
          
          HEALTH_URL="http://192.168.50.110:30777/api/health"
          if curl -f --max-time 10 $HEALTH_URL; then
            echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ìƒ ë™ìž‘ í™•ì¸"
          else
            echo "âŒ ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨"
            exit 1
          fi

      - name: Generate Deployment Summary
        run: |
          echo "ðŸ“‹ ë°°í¬ ìš”ì•½ ë¦¬í¬íŠ¸ ìƒì„±..."
          
          cat > deployment-summary.md << EOF
          # FortiGate Nextrade ë°°í¬ ìš”ì•½
          
          ## ë°°í¬ ì •ë³´
          - **ì‹œê°„**: $(date)
          - **ë¸Œëžœì¹˜**: ${{ github.ref_name }}
          - **ì»¤ë°‹**: ${{ github.sha }}
          - **íŠ¸ë¦¬ê±°**: ${{ github.event_name }}
          
          ## ì²˜ë¦¬ëœ ìž‘ì—…
          - âœ… MCP ì„œë²„ ì´ˆê¸°í™” ë° êµ¬ì„±
          - âœ… Claude Code ì»¤ë§¨ë“œ ì„¤ì •
          - âœ… ìžë™í™”ëœ í’ˆì§ˆ ê²€ì‚¬
          - âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
          - âœ… Kubernetes ë°°í¬
          - âœ… ë°°í¬ í›„ ê²€ì¦
          
          ## MCP ì„œë²„ ìƒíƒœ
          $(cat mcp-config/mcp-servers.json | jq -r '.servers | to_entries[] | "- âœ… \(.key)"')
          
          ## ë‹¤ìŒ ë‹¨ê³„
          - ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ í™•ì¸
          - ë¡œê·¸ ë¶„ì„ ë° ìµœì í™”
          - ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
          EOF

      - name: Upload Deployment Summary
        uses: actions/upload-artifact@v4
        with:
          name: deployment-summary
          path: deployment-summary.md

  # ìžë™í™” ì›Œí¬í”Œë¡œìš° ì™„ë£Œ ì•Œë¦¼
  completion-notification:
    runs-on: ubuntu-latest
    needs: [mcp-initialization, claude-commands-setup, automated-quality-check, automated-deployment, post-deployment-verification]
    if: always()
    steps:
      - name: Workflow Completion Status
        run: |
          echo "ðŸŽ¯ Claude Code + MCP ìžë™í™” ì›Œí¬í”Œë¡œìš° ì™„ë£Œ!"
          echo ""
          echo "ðŸ“Š ìž‘ì—… ìƒíƒœ:"
          echo "  â€¢ MCP ì´ˆê¸°í™”: ${{ needs.mcp-initialization.result }}"
          echo "  â€¢ Claude ì»¤ë§¨ë“œ ì„¤ì •: ${{ needs.claude-commands-setup.result }}"
          echo "  â€¢ í’ˆì§ˆ ê²€ì‚¬: ${{ needs.automated-quality-check.result }}"
          echo "  â€¢ ë°°í¬: ${{ needs.automated-deployment.result }}"
          echo "  â€¢ ê²€ì¦: ${{ needs.post-deployment-verification.result }}"
          echo ""
          echo "ðŸ”— ìœ ìš©í•œ ë§í¬:"
          echo "  â€¢ Registry: https://registry.jclee.me"
          echo "  â€¢ ArgoCD: https://argo.jclee.me"
          echo "  â€¢ Application: http://192.168.50.110:30777"
          echo ""
          echo "âœ¨ ëª¨ë“  ìž‘ì—…ì´ ìžë™í™”ë˜ì–´ ë™ìž‘í•©ë‹ˆë‹¤!"