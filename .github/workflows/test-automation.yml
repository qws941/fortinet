name: Test Automation Workflow

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'í…ŒìŠ¤íŠ¸ íƒ€ì…'
        required: true
        default: 'simple'
        type: choice
        options:
          - 'simple'
          - 'full'

jobs:
  test-simple-automation:
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'simple' || github.event.inputs.test_type == ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test Simple Automation
        run: |
          echo "ğŸš€ FortiGate Nextrade ê°„ë‹¨ ìë™í™” í…ŒìŠ¤íŠ¸ ì‹œì‘..."
          echo "ğŸ“… í˜„ì¬ ì‹œê°„: $(date)"
          echo "ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo "ğŸ“ ì»¤ë°‹: ${{ github.sha }}"
          
          # Git ìƒíƒœ í™•ì¸
          echo ""
          echo "ğŸ“‹ Git ìƒíƒœ:"
          git status --short || echo "  âœ… ì‘ì—… íŠ¸ë¦¬ ê¹¨ë—í•¨"
          
          # í”„ë¡œì íŠ¸ êµ¬ì¡° í™•ì¸
          echo ""
          echo "ğŸ“‚ í”„ë¡œì íŠ¸ êµ¬ì¡°:"
          ls -la | head -10
          
          # Claude Code ì„¤ì • í™•ì¸
          echo ""
          echo "ğŸ”Œ Claude Code ì„¤ì •:"
          if [ -f ".claude/mcp-integration-config.json" ]; then
            echo "  âœ… MCP í†µí•© ì„¤ì • ì¡´ì¬"
            echo "  ğŸ“Š ë“±ë¡ëœ ì„œë²„ ìˆ˜: $(cat .claude/mcp-integration-config.json | jq '.servers | keys | length')"
          else
            echo "  âŒ MCP ì„¤ì • ì—†ìŒ"
          fi
          
          if [ -f ".claude/automation-manager.py" ]; then
            echo "  âœ… ìë™í™” ë§¤ë‹ˆì € ì¡´ì¬"
          else
            echo "  âŒ ìë™í™” ë§¤ë‹ˆì € ì—†ìŒ"
          fi
          
          # GitHub Actions ì›Œí¬í”Œë¡œìš° í™•ì¸
          echo ""
          echo "ğŸ—ï¸ GitHub Actions ì›Œí¬í”Œë¡œìš°:"
          ls -la .github/workflows/ | grep -E "\.(yml|yaml)$" | wc -l | xargs echo "  ğŸ“Š ì›Œí¬í”Œë¡œìš° ìˆ˜:"
          
          # Python í™˜ê²½ í™•ì¸
          echo ""
          echo "ğŸ Python í™˜ê²½:"
          python3 --version
          which python3
          
          # ì„±ê³µ ë©”ì‹œì§€
          echo ""
          echo "âœ… ê°„ë‹¨ ìë™í™” í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"
          echo "ğŸ¯ ì‹œìŠ¤í…œ ì¤€ë¹„ ìƒíƒœ: ì–‘í˜¸"

  test-project-health:
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'full'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
          if [ -f "config/requirements.txt" ]; then
            pip install -r config/requirements.txt
          else
            echo "âš ï¸ requirements.txt ì—†ìŒ"
          fi
          
          # ì½”ë“œ í’ˆì§ˆ ë„êµ¬ ì„¤ì¹˜
          pip install black isort flake8 pytest

      - name: Full Automation Test
        run: |
          echo "ğŸ§ª ì „ì²´ ìë™í™” í…ŒìŠ¤íŠ¸ ì‹œì‘..."
          
          # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
          echo ""
          echo "ğŸ§¹ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬:"
          if [ -d "src" ]; then
            echo "  ğŸ“‹ Black í¬ë§· ê²€ì‚¬..."
            black --check src/ || echo "  âš ï¸ Black í¬ë§· ìˆ˜ì • í•„ìš”"
            
            echo "  ğŸ“‹ Isort ê²€ì‚¬..."
            isort --check-only src/ || echo "  âš ï¸ Import ì •ë ¬ ìˆ˜ì • í•„ìš”"
            
            echo "  ğŸ“‹ Flake8 ë¦°íŒ…..."
            flake8 src/ --max-line-length=120 --ignore=E203,W503 || echo "  âš ï¸ Flake8 ìˆ˜ì • í•„ìš”"
          else
            echo "  â„¹ï¸ src ë””ë ‰í† ë¦¬ ì—†ìŒ"
          fi
          
          # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          echo ""
          echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰:"
          if [ -d "tests" ]; then
            pytest tests/ -v || echo "  âš ï¸ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
          else
            echo "  â„¹ï¸ tests ë””ë ‰í† ë¦¬ ì—†ìŒ"
          fi
          
          # ìë™í™” ë§¤ë‹ˆì € í…ŒìŠ¤íŠ¸
          echo ""
          echo "ğŸ¤– ìë™í™” ë§¤ë‹ˆì € í…ŒìŠ¤íŠ¸:"
          if [ -f ".claude/automation-manager.py" ]; then
            echo "  ğŸ“‹ êµ¬ë¬¸ ê²€ì‚¬..."
            python3 -m py_compile .claude/automation-manager.py && echo "  âœ… êµ¬ë¬¸ ê²€ì‚¬ í†µê³¼" || echo "  âŒ êµ¬ë¬¸ ì˜¤ë¥˜"
          else
            echo "  âŒ ìë™í™” ë§¤ë‹ˆì € íŒŒì¼ ì—†ìŒ"
          fi
          
          echo ""
          echo "ğŸ‰ ì „ì²´ ìë™í™” í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"

  test-workflow-integration:
    runs-on: ubuntu-latest
    needs: [test-simple-automation]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test Workflow Integration
        run: |
          echo "ğŸ”„ ì›Œí¬í”Œë¡œìš° í†µí•© í…ŒìŠ¤íŠ¸..."
          
          # ì›Œí¬í”Œë¡œìš° íŒŒì¼ë“¤ ê²€ì¦
          echo ""
          echo "ğŸ“‹ ì›Œí¬í”Œë¡œìš° íŒŒì¼ ê²€ì¦:"
          for workflow in .github/workflows/*.yml; do
            if [ -f "$workflow" ]; then
              echo "  ğŸ“„ $(basename "$workflow")"
              # YAML êµ¬ë¬¸ ê²€ì‚¬ (ê¸°ë³¸)
              python3 -c "import yaml; yaml.safe_load(open('$workflow'))" && echo "    âœ… YAML êµ¬ë¬¸ ìœ íš¨" || echo "    âŒ YAML êµ¬ë¬¸ ì˜¤ë¥˜"
            fi
          done
          
          # í™˜ê²½ ë³€ìˆ˜ í™•ì¸
          echo ""
          echo "ğŸ”‘ í™˜ê²½ ë³€ìˆ˜:"
          echo "  ğŸ“Š GITHUB_TOKEN: $([ -n '${{ secrets.GITHUB_TOKEN }}' ] && echo 'âœ… ì„¤ì •ë¨' || echo 'âŒ ì—†ìŒ')"
          echo "  ğŸ“Š GITHUB_WORKSPACE: ${{ github.workspace }}"
          echo "  ğŸ“Š GITHUB_REF_NAME: ${{ github.ref_name }}"
          
          # ìµœì¢… ìƒíƒœ ë¦¬í¬íŠ¸
          echo ""
          echo "ğŸ“Š ìµœì¢… ìƒíƒœ ë¦¬í¬íŠ¸:"
          echo "  ğŸ¯ í…ŒìŠ¤íŠ¸ í™˜ê²½: GitHub Actions"
          echo "  ğŸ¯ ì‹¤í–‰ ì‹œê°„: $(date)"
          echo "  ğŸ¯ ì›Œí¬í”Œë¡œìš°: ì •ìƒ ë™ì‘"
          echo ""
          echo "âœ… ì›Œí¬í”Œë¡œìš° í†µí•© í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"

  completion-summary:
    runs-on: ubuntu-latest
    needs: [test-simple-automation, test-project-health, test-workflow-integration]
    if: always()
    steps:
      - name: Test Results Summary
        run: |
          echo "ğŸ¯ FortiGate Nextrade ìë™í™” í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"
          echo "========================================="
          echo ""
          echo "ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼:"
          echo "  â€¢ ê°„ë‹¨ í…ŒìŠ¤íŠ¸: ${{ needs.test-simple-automation.result }}"
          echo "  â€¢ í”„ë¡œì íŠ¸ í—¬ìŠ¤: ${{ needs.test-project-health.result }}"
          echo "  â€¢ ì›Œí¬í”Œë¡œìš° í†µí•©: ${{ needs.test-workflow-integration.result }}"
          echo ""
          echo "ğŸ”— ìœ ìš©í•œ ì •ë³´:"
          echo "  â€¢ ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo "  â€¢ ì»¤ë°‹: ${{ github.sha }}"
          echo "  â€¢ ì‹¤í–‰ ì‹œê°„: $(date)"
          echo ""
          
          # ì „ì²´ ì„±ê³µ ì—¬ë¶€ íŒë‹¨
          if [ "${{ needs.test-simple-automation.result }}" == "success" ]; then
            echo "ğŸ‰ ìë™í™” ì‹œìŠ¤í…œì´ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤!"
            echo "âœ¨ ì´ì œ /main ì»¤ë§¨ë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          else
            echo "âš ï¸ ì¼ë¶€ í…ŒìŠ¤íŠ¸ì—ì„œ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
            echo "ğŸ”§ ë¬¸ì œ í•´ê²° í›„ ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•´ì£¼ì„¸ìš”."
          fi