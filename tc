#!/bin/bash
# TC/CC - Tmux + Claude Code í†µí•© ëª…ë ¹ì–´
set -euo pipefail

SESSION_NAME="${1:-}"

if [[ -z "$SESSION_NAME" ]]; then
    echo "Usage: tc/cc <session-name>"
    echo "Example: tc blacklist"
    exit 1
fi

# í”„ë¡œì íŠ¸ ê²½ë¡œ ìë™ íƒì§€
PROJECT_PATH=""
CANDIDATES=(
    "/home/jclee/app/$SESSION_NAME"
    "/home/jclee/synology/$SESSION_NAME"
)

for path in "${CANDIDATES[@]}"; do
    if [[ -d "$path" ]]; then
        PROJECT_PATH="$path"
        break
    fi
done

if [[ -z "$PROJECT_PATH" ]]; then
    echo "âŒ Project not found: $SESSION_NAME"
    echo "Searched in:"
    printf "  - %s\n" "${CANDIDATES[@]}"
    exit 1
fi

echo "ğŸš€ Starting TC for: $SESSION_NAME"
echo "ğŸ“ Path: $PROJECT_PATH"

# Tmux ì„¸ì…˜ ìƒì„± ë˜ëŠ” ì—°ê²°
SOCKET_PATH="/home/jclee/.tmux/sockets/$SESSION_NAME"

if tmux -S "$SOCKET_PATH" has-session -t "$SESSION_NAME" 2>/dev/null; then
    echo "âœ… Session exists, attaching..."
    if [[ -n "${TMUX:-}" ]]; then
        # ì´ë¯¸ tmux ì•ˆì— ìˆìœ¼ë©´ ìƒˆ ìœˆë„ìš°ë¡œ
        tmux new-window -n "$SESSION_NAME" "cd '$PROJECT_PATH' && exec tmux -S '$SOCKET_PATH' attach-session -t '$SESSION_NAME'"
    else
        cd "$PROJECT_PATH"
        exec tmux -S "$SOCKET_PATH" attach-session -t "$SESSION_NAME"
    fi
else
    echo "ğŸ†• Creating new session..."
    
    # ì„¸ì…˜ ìƒì„±
    tmux -S "$SOCKET_PATH" new-session -d -s "$SESSION_NAME" -c "$PROJECT_PATH"
    
    # Claude Code ìë™ ì‹¤í–‰
    tmux -S "$SOCKET_PATH" send-keys -t "$SESSION_NAME" "claude" Enter
    
    # ì„¸ì…˜ ì ‘ì†
    if [[ -n "${TMUX:-}" ]]; then
        tmux new-window -n "$SESSION_NAME" "exec tmux -S '$SOCKET_PATH' attach-session -t '$SESSION_NAME'"
    else
        exec tmux -S "$SOCKET_PATH" attach-session -t "$SESSION_NAME"
    fi
fi
