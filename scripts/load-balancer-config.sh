#!/bin/bash
# =============================================================================
# FortiGate Nextrade - Ïô∏Î∂Ä Ìè¨Ìä∏ Î°úÎìúÎ∞∏Îü∞ÏÑú ÏÑ§Ï†ï
# App 7777 Ìè¨Ìä∏ ÏàúÏ∞®Ï†Å Î∑∞ ÎùºÏö∞ÌåÖ Íµ¨ÏÑ±
# =============================================================================

set -e

# Configuration
EXTERNAL_PORT="${EXTERNAL_PORT:-80}"
INTERNAL_PORT="7777"
APP_INSTANCES="${APP_INSTANCES:-3}"
HEALTH_CHECK_INTERVAL="${HEALTH_CHECK_INTERVAL:-30}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
echo_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
echo_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
echo_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Traefik Î°úÎìúÎ∞∏Îü∞ÏÑú ÏÑ§Ï†ï ÏÉùÏÑ±
generate_traefik_config() {
    echo_info "üîß Traefik Î°úÎìúÎ∞∏Îü∞ÏÑú ÏÑ§Ï†ï ÏÉùÏÑ± Ï§ë..."
    
    mkdir -p config/traefik
    
    cat > config/traefik/traefik.yml << EOF
# Traefik ÎèôÏ†Å ÏÑ§Ï†ï
global:
  checkNewVersion: false
  sendAnonymousUsage: false

serversTransport:
  insecureSkipVerify: true

api:
  dashboard: true
  insecure: true

entryPoints:
  web:
    address: ":${EXTERNAL_PORT}"
  websecure:
    address: ":443"
  traefik:
    address: ":8080"

providers:
  docker:
    endpoint: "unix:///var/run/docker.sock"
    exposedByDefault: false
    network: fortinet-network
  file:
    filename: /etc/traefik/dynamic.yml
    watch: true

certificatesResolvers:
  letsencrypt:
    acme:
      email: admin@jclee.me
      storage: /letsencrypt/acme.json
      httpChallenge:
        entryPoint: web

log:
  level: INFO
  format: json

accessLog:
  format: json
  fields:
    defaultMode: keep
    names:
      ClientUsername: drop
    headers:
      defaultMode: keep
      names:
        User-Agent: keep
        Authorization: drop
        Content-Type: keep

metrics:
  prometheus:
    addEntryPointsLabels: true
    addServicesLabels: true
EOF

    # ÎèôÏ†Å ÏÑ§Ï†ï ÌååÏùº
    cat > config/traefik/dynamic.yml << EOF
# Traefik ÎèôÏ†Å ÎùºÏö∞ÌåÖ ÏÑ§Ï†ï
http:
  routers:
    fortinet-app:
      rule: "Host(\`fortinet.jclee.me\`) || Host(\`localhost\`)"
      service: fortinet-service
      entrypoints:
        - web
        - websecure
      tls:
        certResolver: letsencrypt
      middlewares:
        - fortinet-auth
        - fortinet-ratelimit
        - fortinet-headers

    fortinet-api:
      rule: "Host(\`fortinet.jclee.me\`) && PathPrefix(\`/api\`)"
      service: fortinet-api-service
      entrypoints:
        - web
        - websecure
      tls:
        certResolver: letsencrypt
      middlewares:
        - fortinet-api-ratelimit
        - fortinet-headers

  services:
    fortinet-service:
      loadBalancer:
        healthCheck:
          path: /api/health
          interval: ${HEALTH_CHECK_INTERVAL}s
          timeout: 10s
        sticky:
          cookie:
            name: fortinet-server
            secure: true
            httpOnly: true
        servers:
EOF

    # ÏàúÏ∞®Ï†Å ÏÑúÎ≤Ñ Ï∂îÍ∞Ä
    for i in $(seq 1 $APP_INSTANCES); do
        port=$((30776 + i))
        cat >> config/traefik/dynamic.yml << EOF
          - url: "http://172.20.0.3${i}:7777"
            weight: 1
EOF
    done

    cat >> config/traefik/dynamic.yml << EOF

    fortinet-api-service:
      loadBalancer:
        healthCheck:
          path: /api/health
          interval: 10s
          timeout: 5s
        servers:
EOF

    # API Ï†ÑÏö© ÏÑúÎ≤Ñ ÏÑ§Ï†ï
    for i in $(seq 1 $APP_INSTANCES); do
        cat >> config/traefik/dynamic.yml << EOF
          - url: "http://172.20.0.3${i}:7777"
            weight: 1
EOF
    done

    cat >> config/traefik/dynamic.yml << EOF

  middlewares:
    fortinet-auth:
      basicAuth:
        users:
          - "admin:{\$2a\$10\$XYZ123456789..." # bcrypt hash

    fortinet-ratelimit:
      rateLimit:
        burst: 100
        period: 1m
        average: 50

    fortinet-api-ratelimit:
      rateLimit:
        burst: 200
        period: 1m
        average: 100

    fortinet-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: "https"
          X-Real-IP: ""
        customResponseHeaders:
          X-Frame-Options: "DENY"
          X-Content-Type-Options: "nosniff"
          X-XSS-Protection: "1; mode=block"
          Strict-Transport-Security: "max-age=31536000; includeSubDomains"

tls:
  options:
    default:
      sslProtocols:
        - "TLSv1.2"
        - "TLSv1.3"
      cipherSuites:
        - "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384"
        - "TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305"
        - "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256"
EOF

    echo_success "Traefik ÏÑ§Ï†ï ÏÉùÏÑ± ÏôÑÎ£å"
}

# Docker Compose ÌôïÏû• ÏÑ§Ï†ï ÏÉùÏÑ±
generate_loadbalancer_compose() {
    echo_info "üê≥ Î°úÎìúÎ∞∏Îü∞ÏÑú Docker Compose ÏÑ§Ï†ï ÏÉùÏÑ±..."
    
    cat > docker-compose.loadbalancer.yml << EOF
version: '3.8'

networks:
  fortinet-network:
    external: true
  traefik-network:
    driver: bridge

volumes:
  traefik-letsencrypt:
    driver: local

services:
  # Traefik Î°úÎìúÎ∞∏Îü∞ÏÑú
  traefik:
    image: traefik:v3.0
    container_name: fortinet-traefik
    hostname: fortinet-traefik
    restart: unless-stopped
    networks:
      - fortinet-network
      - traefik-network
    ports:
      - "${EXTERNAL_PORT}:80"
      - "443:443"
      - "8080:8080"  # Traefik Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config/traefik:/etc/traefik:ro
      - traefik-letsencrypt:/letsencrypt
    environment:
      - TRAEFIK_API=true
      - TRAEFIK_API_DASHBOARD=true
      - TRAEFIK_API_INSECURE=true
      - TRAEFIK_PROVIDERS_DOCKER=true
      - TRAEFIK_PROVIDERS_DOCKER_EXPOSEDBYDEFAULT=false
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(\`traefik.jclee.me\`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik.service=api@internal"
      - "com.centurylinklabs.watchtower.enable=false"

  # Ïï± Ïù∏Ïä§ÌÑ¥Ïä§ 1
  fortinet-app-1:
    extends:
      file: docker-compose-separated.yml
      service: fortinet
    container_name: fortinet-app-1
    hostname: fortinet-app-1
    networks:
      fortinet-network:
        ipv4_address: 172.20.0.31
    ports:
      - "30777:7777"
    environment:
      - INSTANCE_ID=1
      - INSTANCE_NAME=fortinet-app-1
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.app1.rule=Host(\`fortinet.jclee.me\`) && PathPrefix(\`/instance1\`)"
      - "traefik.http.services.app1.loadbalancer.server.port=7777"
      - "com.centurylinklabs.watchtower.scope=fortinet-app"

  # Ïï± Ïù∏Ïä§ÌÑ¥Ïä§ 2  
  fortinet-app-2:
    extends:
      file: docker-compose-separated.yml
      service: fortinet
    container_name: fortinet-app-2
    hostname: fortinet-app-2
    networks:
      fortinet-network:
        ipv4_address: 172.20.0.32
    ports:
      - "30778:7777"
    environment:
      - INSTANCE_ID=2
      - INSTANCE_NAME=fortinet-app-2
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.app2.rule=Host(\`fortinet.jclee.me\`) && PathPrefix(\`/instance2\`)"
      - "traefik.http.services.app2.loadbalancer.server.port=7777"
      - "com.centurylinklabs.watchtower.scope=fortinet-app"

  # Ïï± Ïù∏Ïä§ÌÑ¥Ïä§ 3
  fortinet-app-3:
    extends:
      file: docker-compose-separated.yml
      service: fortinet
    container_name: fortinet-app-3
    hostname: fortinet-app-3
    networks:
      fortinet-network:
        ipv4_address: 172.20.0.33
    ports:
      - "30779:7777"
    environment:
      - INSTANCE_ID=3
      - INSTANCE_NAME=fortinet-app-3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.app3.rule=Host(\`fortinet.jclee.me\`) && PathPrefix(\`/instance3\`)"
      - "traefik.http.services.app3.loadbalancer.server.port=7777"
      - "com.centurylinklabs.watchtower.scope=fortinet-app"
EOF

    echo_success "Î°úÎìúÎ∞∏Îü∞ÏÑú Docker Compose ÏÑ§Ï†ï ÏôÑÎ£å"
}

# ÏàúÏ∞®Ï†Å Î∑∞ ÎùºÏö∞ÌåÖ Ïä§ÌÅ¨Î¶ΩÌä∏
generate_sequential_routing() {
    echo_info "üîÑ ÏàúÏ∞®Ï†Å Î∑∞ ÎùºÏö∞ÌåÖ Ïä§ÌÅ¨Î¶ΩÌä∏ ÏÉùÏÑ±..."
    
    cat > scripts/sequential-router.py << 'EOF'
#!/usr/bin/env python3
"""
FortiGate Nextrade - ÏàúÏ∞®Ï†Å Î∑∞ ÎùºÏö∞ÌåÖ Í¥ÄÎ¶¨
Ïô∏Î∂Ä Ìè¨Ìä∏ÏóêÏÑú ÎÇ¥Î∂Ä Ïï± Ïù∏Ïä§ÌÑ¥Ïä§Î°ú ÏàúÏ∞® Î∂ÑÎ∞∞
"""

import time
import json
import requests
import logging
from typing import List, Dict
from dataclasses import dataclass

@dataclass
class AppInstance:
    id: int
    name: str
    url: str
    port: int
    healthy: bool = False
    last_check: float = 0
    response_time: float = 0

class SequentialRouter:
    def __init__(self, instances: List[Dict], health_check_interval: int = 30):
        self.instances = [AppInstance(**inst) for inst in instances]
        self.current_index = 0
        self.health_check_interval = health_check_interval
        self.logger = self._setup_logging()
        
    def _setup_logging(self):
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
        )
        return logging.getLogger('SequentialRouter')

    def health_check(self, instance: AppInstance) -> bool:
        """Í∞úÎ≥Ñ Ïù∏Ïä§ÌÑ¥Ïä§ health check"""
        try:
            start_time = time.time()
            response = requests.get(
                f"{instance.url}/api/health",
                timeout=10,
                headers={'User-Agent': 'SequentialRouter/1.0'}
            )
            instance.response_time = time.time() - start_time
            instance.last_check = time.time()
            
            if response.status_code == 200:
                instance.healthy = True
                self.logger.debug(f"‚úÖ {instance.name} is healthy (response: {instance.response_time:.3f}s)")
                return True
            else:
                instance.healthy = False
                self.logger.warning(f"‚ùå {instance.name} unhealthy (status: {response.status_code})")
                return False
                
        except Exception as e:
            instance.healthy = False
            instance.last_check = time.time()
            self.logger.error(f"‚ùå {instance.name} health check failed: {e}")
            return False

    def check_all_instances(self):
        """Î™®Îì† Ïù∏Ïä§ÌÑ¥Ïä§ health check"""
        current_time = time.time()
        
        for instance in self.instances:
            if current_time - instance.last_check > self.health_check_interval:
                self.health_check(instance)

    def get_next_healthy_instance(self) -> AppInstance:
        """ÏàúÏ∞®Ï†ÅÏúºÎ°ú Îã§Ïùå healthy Ïù∏Ïä§ÌÑ¥Ïä§ Î∞òÌôò"""
        self.check_all_instances()
        
        # Î™®Îì† Ïù∏Ïä§ÌÑ¥Ïä§Í∞Ä unhealthyÏù∏ Í≤ΩÏö∞
        healthy_instances = [inst for inst in self.instances if inst.healthy]
        if not healthy_instances:
            self.logger.error("üö® Î™®Îì† Ïù∏Ïä§ÌÑ¥Ïä§Í∞Ä unhealthy ÏÉÅÌÉúÏûÖÎãàÎã§!")
            # Ï≤´ Î≤àÏß∏ Ïù∏Ïä§ÌÑ¥Ïä§ÎùºÎèÑ Î∞òÌôò (fallback)
            return self.instances[0]
        
        # ÏàúÏ∞®Ï†Å ÏÑ†ÌÉù (Round Robin)
        self.current_index = (self.current_index + 1) % len(healthy_instances)
        selected = healthy_instances[self.current_index]
        
        self.logger.info(f"üéØ Selected instance: {selected.name} (response_time: {selected.response_time:.3f}s)")
        return selected

    def get_status(self) -> Dict:
        """ÌòÑÏû¨ ÏÉÅÌÉú Î∞òÌôò"""
        self.check_all_instances()
        
        return {
            'timestamp': time.time(),
            'total_instances': len(self.instances),
            'healthy_instances': len([inst for inst in self.instances if inst.healthy]),
            'current_index': self.current_index,
            'instances': [
                {
                    'id': inst.id,
                    'name': inst.name,
                    'url': inst.url,
                    'healthy': inst.healthy,
                    'response_time': inst.response_time,
                    'last_check': inst.last_check
                }
                for inst in self.instances
            ]
        }

# ÏÑ§Ï†ï ÏòàÏ†ú
if __name__ == "__main__":
    instances = [
        {'id': 1, 'name': 'fortinet-app-1', 'url': 'http://172.20.0.31:7777', 'port': 30777},
        {'id': 2, 'name': 'fortinet-app-2', 'url': 'http://172.20.0.32:7777', 'port': 30778}, 
        {'id': 3, 'name': 'fortinet-app-3', 'url': 'http://172.20.0.33:7777', 'port': 30779}
    ]
    
    router = SequentialRouter(instances)
    
    # ÏÉÅÌÉú Î™®ÎãàÌÑ∞ÎßÅ
    while True:
        status = router.get_status()
        print(f"üìä Router Status: {status['healthy_instances']}/{status['total_instances']} healthy")
        
        # Îã§Ïùå Ïù∏Ïä§ÌÑ¥Ïä§ ÌÖåÏä§Ìä∏
        next_instance = router.get_next_healthy_instance()
        print(f"‚û°Ô∏è  Next: {next_instance.name}")
        
        time.sleep(10)
EOF

    chmod +x scripts/sequential-router.py
    echo_success "ÏàúÏ∞®Ï†Å Î∑∞ ÎùºÏö∞ÌåÖ Ïä§ÌÅ¨Î¶ΩÌä∏ ÏôÑÎ£å"
}

# Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏
generate_deployment_script() {
    echo_info "üöÄ Î°úÎìúÎ∞∏Îü∞ÏÑú Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏ ÏÉùÏÑ±..."
    
    cat > scripts/deploy-loadbalancer.sh << 'EOF'
#!/bin/bash
# Î°úÎìúÎ∞∏Îü∞ÏÑú Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏

set -e

echo "üöÄ FortiGate Î°úÎìúÎ∞∏Îü∞ÏÑú Î∞∞Ìè¨ ÏãúÏûë..."

# Í∏∞Ï°¥ ÏÑúÎπÑÏä§ Ï§ëÏßÄ
echo "‚èπÔ∏è Í∏∞Ï°¥ ÏÑúÎπÑÏä§ Ï§ëÏßÄ..."
docker-compose -f docker-compose-separated.yml down 2>/dev/null || true
docker-compose -f docker-compose.loadbalancer.yml down 2>/dev/null || true

# ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉùÏÑ±
echo "üåê ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÑ§Ï†ï..."
docker network create fortinet-network 2>/dev/null || true

# ÏÑúÎπÑÏä§ ÏãúÏûë (ÏùòÏ°¥ÏÑ± ÏàúÏÑú)
echo "üì¶ Redis & PostgreSQL ÏãúÏûë..."
docker-compose -f docker-compose-separated.yml up -d redis postgresql

# Health check ÎåÄÍ∏∞
echo "‚è≥ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏÑúÎπÑÏä§ Ï§ÄÎπÑ ÎåÄÍ∏∞..."
sleep 30

# Ïï± Ïù∏Ïä§ÌÑ¥Ïä§Îì§Í≥º Î°úÎìúÎ∞∏Îü∞ÏÑú ÏãúÏûë
echo "üîß Ïï± Ïù∏Ïä§ÌÑ¥Ïä§ Î∞è Î°úÎìúÎ∞∏Îü∞ÏÑú ÏãúÏûë..."
docker-compose -f docker-compose.loadbalancer.yml up -d

# ÏÑúÎπÑÏä§ ÏÉÅÌÉú ÌôïÏù∏
echo "üîç ÏÑúÎπÑÏä§ ÏÉÅÌÉú ÌôïÏù∏..."
sleep 15

docker ps --filter "label=traefik.enable=true" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

echo "‚úÖ Î∞∞Ìè¨ ÏôÑÎ£å!"
echo "üìç Ï†ëÏÜç Ï†ïÎ≥¥:"
echo "  - Î©îÏù∏ Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò: http://fortinet.jclee.me"
echo "  - Traefik ÎåÄÏãúÎ≥¥Îìú: http://traefik.jclee.me:8080"
echo "  - Health Check: http://fortinet.jclee.me/api/health"

# ÏàúÏ∞® ÎùºÏö∞ÌÑ∞ ÏãúÏûë ÏòµÏÖò
read -p "ÏàúÏ∞® ÎùºÏö∞ÌÑ∞Î•º ÏãúÏûëÌïòÏãúÍ≤†ÏäµÎãàÍπå? (y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "üîÑ ÏàúÏ∞® ÎùºÏö∞ÌÑ∞ ÏãúÏûë..."
    python3 scripts/sequential-router.py &
    echo "‚úÖ ÏàúÏ∞® ÎùºÏö∞ÌÑ∞Í∞Ä Î∞±Í∑∏ÎùºÏö¥ÎìúÏóêÏÑú Ïã§Ìñâ Ï§ëÏûÖÎãàÎã§"
fi
EOF

    chmod +x scripts/deploy-loadbalancer.sh
    echo_success "Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏ ÏôÑÎ£å"
}

# Ïã§Ìñâ
echo_info "üéØ Ïô∏Î∂Ä Ìè¨Ìä∏ Î°úÎìúÎ∞∏Îü∞ÏÑú ÏÑ§Ï†ï ÏãúÏûë..."
echo "Ïô∏Î∂Ä Ìè¨Ìä∏: $EXTERNAL_PORT"
echo "ÎÇ¥Î∂Ä Ìè¨Ìä∏: $INTERNAL_PORT" 
echo "Ïï± Ïù∏Ïä§ÌÑ¥Ïä§: $APP_INSTANCESÍ∞ú"
echo

generate_traefik_config
generate_loadbalancer_compose
generate_sequential_routing
generate_deployment_script

echo_success "üéâ Ïô∏Î∂Ä Ìè¨Ìä∏ Î°úÎìúÎ∞∏Îü∞ÏÑú ÏÑ§Ï†ï ÏôÑÎ£å!"
echo_info "üí° Î∞∞Ìè¨ Î∞©Î≤ï:"
echo "  ./scripts/deploy-loadbalancer.sh"